<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server Sent Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  </head>
  <body class="h-screen flex items-center justify-center">
    <div class="grid w-screen mx-auto">
      <h1 class="text-lg font-bold text-center m-4">Memory Usage</h1>

      <div class="m-4" id="line-chart"></div>

      <ul class="mx-auto">
        <li class="flex justify-between space-x-5">
          <div class="font-bold">In use:</div>
          <div id="in_use"></div>
        </li>
        <li class="flex justify-between space-x-5">
          <div class="font-bold">Available:</div>
          <div id="available"></div>
        </li>
        <li class="flex justify-between space-x-5">
          <div class="font-bold">Total:</div>
          <div id="total"></div>
        </li>
      </ul>

      <div
        class="text-center w-full mt-8 mb-0 mx-auto text-sm"
      >
        Made with ‚ù§ by
        <a
          href="https://linktr.ee/codelikesuraj?utm_source=linktree_profile_share&ltsid=f778c799-fc05-43e9-9fd0-d6b85cab4a03"
          target="_blank"
          class="underline"
          >Abdulbaki Suraj</a
        >
        <div class="text-center space-x-1 mt-1">
          <a
            class="underline"
            href="https://github.com/codelikesuraj"
            target="_blank"
            >Github</a
          >
          <a
            class="underline"
            href="https://linkedin.com/in/abdulbaki-suraj"
            target="_blank"
            >LinkedIn</a
          >
          <a
            class="underline"
            href="https://x.com/fliplikesuraj"
            target="_blank"
            >X(Twitter)</a
          >
        </div>
      </div>
    </div>
  </body>
  <script>
    let newData = {
      in_use: [],
    };

    const formatToMB = (value) => parseFloat(value / 1024 / 1024).toFixed(1);
    const eventSource = new EventSource("events");
    const chart = new ApexCharts(document.getElementById("line-chart"), {
      tooltip: {
        enabled: true,
        x: { show: true },
        y: { show: true },
      },
      grid: {
        show: true,
        strokeDashArray: 4,
        padding: {
          left: 2,
          right: 2,
          top: -26,
        },
      },
      series: [
        {
          name: "In use",
          data: newData.in_use.slice(),
        },
      ],
      noData: { text: "Loading..." },
      chart: {
        height: "100%",
        maxWidth: "100%",
        type: "area",
        animations: {
          enabled: true,
          easing: "easeinout",
          dynamicAnimation: { speed: 1 },
        },
        toolbar: { show: false },
      },
      dataLabels: {
        enabled: false,
        type: "timestamp",
      },
      stroke: {
        width: 3,
        curve: "smooth",
      },
      xaxis: {
        labels: { show: false },
        axisBorder: { show: false },
        axisTicks: { show: false },
      },
    });
    chart.render();

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data);
      const in_use = formatToMB(data.in_use);

      document.getElementById("total").innerHTML =
        formatToMB(data.total) + "MB";
      document.getElementById("in_use").innerHTML = in_use + "MB";
      document.getElementById("available").innerHTML =
        formatToMB(data.available) + "MB";

      let t = new Date().toLocaleTimeString();

      newData.in_use.push({ x: t, y: Number(in_use) });

      if (newData.in_use.length > 30) {
        newData.in_use.shift();
      }

      chart.updateSeries([{ data: newData.in_use }]);
    };
  </script>
</html>
